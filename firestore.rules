rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - users can read/write their own data
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for displaying names, etc.)
      allow read: if isAuthenticated();
      
      // Users can only create/update their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Clients/Accounts collection
    match /clients/{clientId} {
      // All authenticated users can read clients
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete clients
      allow create, update, delete: if isAdmin();
    }
    
    // Equipment collection
    match /equipment/{equipmentId} {
      // All authenticated users can read equipment
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update equipment
      allow create, update: if isAuthenticated();
      
      // Only admins can delete equipment
      allow delete: if isAdmin();
    }
    
    // Service history/tickets collection
    match /services/{serviceId} {
      // All authenticated users can read services
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update services
      allow create, update: if isAuthenticated();
      
      // Only admins can delete services
      allow delete: if isAdmin();
    }
    
    // Invoices collection
    match /invoices/{invoiceId} {
      // All authenticated users can read invoices
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update invoices
      allow create, update: if isAuthenticated();
      
      // Only admins can delete invoices
      allow delete: if isAdmin();
    }
    
    // Inventory collection
    match /inventory/{inventoryId} {
      // All authenticated users can read inventory
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update inventory
      allow create, update: if isAuthenticated();
      
      // Only admins can delete inventory items
      allow delete: if isAdmin();
    }
    
    // Parts catalog/orders collection
    match /parts/{partId} {
      // All authenticated users can read parts
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update parts
      allow create, update: if isAuthenticated();
      
      // Only admins can delete parts
      allow delete: if isAdmin();
    }
    
    // Service manuals collection
    match /manuals/{manualId} {
      // All authenticated users can read manuals
      allow read: if isAuthenticated();
      
      // All authenticated users can upload manuals
      allow create, update: if isAuthenticated();
      
      // Only admins can delete manuals
      allow delete: if isAdmin();
    }
    
    // Schedules/Appointments collection
    match /schedules/{scheduleId} {
      // All authenticated users can read schedules
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update schedules
      allow create, update: if isAuthenticated();
      
      // Only admins can delete schedules
      allow delete: if isAdmin();
    }
    
    // QR codes collection
    match /qrcodes/{qrcodeId} {
      // All authenticated users can read QR codes
      allow read: if isAuthenticated();
      
      // All authenticated users can create/update QR codes
      allow create, update: if isAuthenticated();
      
      // Only admins can delete QR codes
      allow delete: if isAdmin();
    }
    
    // Fallback rule - deny access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
